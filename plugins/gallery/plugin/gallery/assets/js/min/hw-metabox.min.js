(function(e){e(function(){function a(a){e(".media-toolbar-secondary span.hw-gallery-spinner").css("visibility","visible"),e.post(hw_gallery_metabox.ajax,{action:"hw_gallery_load_library",offset:a,post_id:hw_gallery_metabox.id,search:e("input#hw-gallery-gallery-search").val(),nonce:hw_gallery_metabox.load_gallery},function(l){e("a.hw-gallery-load-library").attr("data-hw-gallery-offset",Number(a)+20),e(".media-toolbar-secondary span.hw-gallery-spinner").css("visibility","hidden"),0===a?e(".hw-gallery-gallery").html(l.html):e(".hw-gallery-gallery").append(l.html)},"json")}function l(){var a={action:"hw_gallery_refresh",post_id:hw_gallery_metabox.id,nonce:hw_gallery_metabox.refresh_nonce};e(".hw-gallery-media-library").after('<span class="spinner hw-gallery-spinner hw-gallery-spinner-refresh"></span>'),e(".hw-gallery-spinner-refresh").css({display:"inline-block","margin-top":"-3px"}),e.post(hw_gallery_metabox.ajax,a,function(a){a&&a.success&&(e("#hw-gallery-output").html(a.success),e("#hw-gallery-output").find(".wp-editor-wrap").each(function(a,l){var r=e(l).find(".quicktags-toolbar");if(!(r.length>0)){var t=e(l).attr("id").split("-"),o=t.slice(4,-1).join("-");quicktags({id:"hw-gallery-caption-"+o,buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()}}),e("#hw-gallery-output").trigger({type:"hw_galleryRefreshed",html:a.success,id:hw_gallery_metabox.id})),e(".hw-gallery-spinner-refresh").fadeOut(300,function(){e(this).remove()})},"json")}function r(){var a=e("#hw-gallery-config-crop"),l=e("#hw-gallery-config-mobile"),r=e("#hw-gallery-config-lightbox-toolbar");a.is(":checked")&&e("#hw-gallery-config-crop-size-box").fadeIn(300),a.on("change",function(){e(this).is(":checked")?e("#hw-gallery-config-crop-size-box").fadeIn(300):e("#hw-gallery-config-crop-size-box").fadeOut(300)}),l.is(":checked")&&e("#hw-gallery-config-mobile-size-box").fadeIn(300),l.on("change",function(){e(this).is(":checked")?e("#hw-gallery-config-mobile-size-box").fadeIn(300):e("#hw-gallery-config-mobile-size-box").fadeOut(300)}),r.is(":checked")&&e("#hw-gallery-config-lightbox-toolbar-position-box").fadeIn(300),r.on("change",function(){e(this).is(":checked")?e("#hw-gallery-config-lightbox-toolbar-position-box").fadeIn(300):e("#hw-gallery-config-lightbox-toolbar-position-box").fadeOut(300)})}function t(){e("#hw-gallery .drag-drop-inside").append('<div class="hw-gallery-progress-bar"><div></div></div>'),c=new plupload.Uploader(hw_gallery_metabox.plupload);var a=e("#hw-gallery .hw-gallery-progress-bar"),l=e("#hw-gallery .hw-gallery-progress-bar div"),r=e("#hw-gallery-output");c&&(e("#hw-gallery .max-upload-size").append(' <a class="hw-gallery-media-library button button-primary" href="#" title="'+hw_gallery_metabox.gallery+'" style="vertical-align: baseline;">'+hw_gallery_metabox.gallery+"</a>"),c.bind("Init",function(a){var l=e("#hw-gallery-plupload-upload-ui");a.features.dragdrop&&!e(document.body).hasClass("mobile")?(l.addClass("drag-drop"),e("#hw-gallery-drag-drop-area").bind("dragover.wp-uploader",function(){l.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){l.removeClass("drag-over")})):(l.removeClass("drag-drop"),e("#hw-gallery-drag-drop-area").unbind(".wp-uploader")),"html4"==a.runtime&&e(".upload-flash-bypass").hide()}),c.init(),c.bind("FilesAdded",function(l,r){var t=104857600,i=parseInt(l.settings.max_file_size,10);e("#hw-gallery-upload-error").html(""),e(a).show().css("display","block"),plupload.each(r,function(e){i>t&&e.size>t&&"html5"!=l.runtime&&o(l,e,!0)}),l.refresh(),l.start()}),c.bind("UploadProgress",function(a){e(l).css("width",a.total.percent+"%")}),c.bind("FileUploaded",function(a,l,t){e.post(hw_gallery_metabox.ajax,{action:"hw_gallery_load_image",nonce:hw_gallery_metabox.load_image,id:t.response,post_id:hw_gallery_metabox.id},function(a){e(r).append(a),e(a).find(".wp-editor-container").each(function(a,l){var r=e(l).attr("id").split("-")[4];quicktags({id:"hw-gallery-caption-"+r,buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()})},"json")}),c.bind("UploadComplete",function(){e(a).hide().css("display","none"),e(l).removeAttr("style")}),c.bind("Error",function(a,l){var r,t=104857600,i=e("#hw-gallery-upload-error");switch(l){case plupload.FAILED:case plupload.FILE_EXTENSION_ERROR:i.html('<p class="error">'+pluploadL10n.upload_failed+"</p>");break;case plupload.FILE_SIZE_ERROR:o(a,l.file);break;case plupload.IMAGE_FORMAT_ERROR:wpFileError(fileObj,pluploadL10n.not_an_image);break;case plupload.IMAGE_MEMORY_ERROR:wpFileError(fileObj,pluploadL10n.image_memory_exceeded);break;case plupload.IMAGE_DIMENSIONS_ERROR:wpFileError(fileObj,pluploadL10n.image_dimensions_exceeded);break;case plupload.GENERIC_ERROR:wpQueueError(pluploadL10n.upload_failed);break;case plupload.IO_ERROR:r=parseInt(uploader.settings.max_file_size,10),r>t&&fileObj.size>t?wpFileError(fileObj,pluploadL10n.big_upload_failed.replace("%1$s",'<a class="uploader-html" href="#">').replace("%2$s","</a>")):wpQueueError(pluploadL10n.io_error);break;case plupload.HTTP_ERROR:wpQueueError(pluploadL10n.http_error);break;case plupload.INIT_ERROR:e(".media-upload-form").addClass("html-uploader");break;case plupload.SECURITY_ERROR:wpQueueError(pluploadL10n.security_error);break;default:o(a,l.file)}a.refresh()}))}function o(a,l,r){var t;t=r?pluploadL10n.big_upload_queued.replace("%s",l.name)+" "+pluploadL10n.big_upload_failed.replace("%1$s",'<a class="uploader-html" href="#">').replace("%2$s","</a>"):pluploadL10n.file_exceeds_size_limit.replace("%s",l.name),e("#hw-gallery-upload-error").html('<div class="error fade"><p>'+t+"</p></div>"),a.removeFile(l)}var i=e("#hw-gallery-tabs"),n=e("#hw-gallery-tabs-nav"),s=window.location.hash,d=window.location.hash.replace("!","");if(s&&s.indexOf("hw-gallery-tab-")>=0){e(".hw-gallery-active").removeClass("hw-gallery-active"),n.find('li a[href="'+d+'"]').parent().addClass("hw-gallery-active"),i.find(d).addClass("hw-gallery-active").show();var h=e("#post").attr("action");h&&(h=h.split("#")[0],e("#post").attr("action",h+s))}e(document).on("click","#hw-gallery-tabs-nav li a",function(a){a.preventDefault();var l=e(this);if(!l.parent().hasClass("hw-gallery-active")){window.location.hash=s=this.hash.split("#").join("#!");var r=n.find(".hw-gallery-active").removeClass("hw-gallery-active").find("a").attr("href");l.parent().addClass("hw-gallery-active"),i.find(r).removeClass("hw-gallery-active").hide(),i.find(l.attr("href")).addClass("hw-gallery-active").show();var t=e("#post").attr("action");t&&(t=t.split("#")[0],e("#post").attr("action",t+s))}});var c;t(),r(),0!==e(".hw-gallery-helper-needed").length&&e('<div class="hw-gallery-meta-helper-overlay" />').prependTo("#hw-gallery"),e(document).on("click",".hw-gallery-meta-icon",function(a){a.preventDefault();var l=e(this),r=l.parent(),t=l.next();t.is(":visible")?(e(".hw-gallery-meta-helper-overlay").remove(),r.removeClass("hw-gallery-helper-active")):(0===e(".hw-gallery-meta-helper-overlay").length&&e('<div class="hw-gallery-meta-helper-overlay" />').prependTo("#hw-gallery"),r.addClass("hw-gallery-helper-active"))}),e(document).on("click",".hw-gallery-media-library",function(a){a.preventDefault(),m=!0,e("#hw-gallery-upload-ui").appendTo("body").show()}),e(".hw-gallery-gallery").on("click",".thumbnail, .check, .media-modal-icon",function(a){a.preventDefault(),e(this).parent().parent().hasClass("hw-gallery-in-gallery")||(e(this).parent().parent().hasClass("selected")?e(this).parent().parent().removeClass("details selected"):e(this).parent().parent().addClass("details selected"))}),e(document).on("click","a.hw-gallery-load-library",function(){a(e("a.hw-gallery-load-library").attr("data-hw-gallery-offset"))}),e(".hw-gallery-gallery").bind("scroll",function(){e(this).scrollTop()+e(this).innerHeight()>=this.scrollHeight&&a(e("a.hw-gallery-load-library").attr("data-hw-gallery-offset"))}),e(document).on("keyup keydown","#hw-gallery-gallery-search",function(){w(function(){hw_galelryLoadLibraryImages(0)})}),e(document).on("click",".hw-gallery-media-insert",function(a){a.preventDefault();var l=e(this),r=e(this).text(),t={action:"hw_gallery_insert_images",nonce:hw_gallery_metabox.insert_nonce,post_id:hw_gallery_metabox.id,images:{}},o=!1,i=a;l.text(hw_gallery_metabox.inserting),e(".hw-gallery-media-frame").find(".attachment.selected:not(.hw-gallery-in-gallery)").each(function(a,l){t.images[a]=e(l).attr("data-attachment-id"),o=!0}),e.post(hw_gallery_metabox.ajax,t,function(){setTimeout(function(){f(i),l.text(r),o&&e(".hw-gallery-load-library").attr("data-hw-gallery-offset",0).addClass("has-search").trigger("click")},500)},"json")});var p=e("#hw-gallery-output");p.sortable({containment:"#hw-gallery-output",items:"li",cursor:"move",forcePlaceholderSize:!0,placeholder:"dropzone",update:function(){var a={url:hw_gallery_metabox.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"hw_gallery_sort_images",order:""+p.sortable("toArray"),post_id:hw_gallery_metabox.id,nonce:hw_gallery_metabox.sort},success:function(){},error:function(){}};e.ajax(a)}}),e("#hw-gallery").on("click",".hw-gallery-remove-image",function(a){a.preventDefault();var l=confirm(hw_gallery_metabox.remove);if(l){var r=e(this).parent().attr("id"),t={action:"hw_gallery_remove_image",attachment_id:r,post_id:hw_gallery_metabox.id,nonce:hw_gallery_metabox.remove_nonce};e.post(hw_gallery_metabox.ajax,t,function(){e("#"+r).fadeOut("normal",function(){e(this).remove(),e(".hw-gallery-load-library").attr("data-hw-gallery-offset",0).addClass("has-search").trigger("click")})},"json")}}),e("#hw-gallery").on("click",".hw-gallery-modify-image",function(a){a.preventDefault();var l=e(this).parent().data("hw-gallery-image"),r="hw-gallery-meta-"+l;u(l,r)});var g,u=function(a,l){g=e("#"+l).appendTo("body"),e(g).show(),e(document).on("click",".media-modal-close, .media-modal-backdrop",function(e){e.preventDefault(),y()}),e(document).on("keydown",function(e){27==e.keyCode&&y()})},y=function(){var a=e(g).attr("id"),l=a.split("-"),r=l[l.length-1];e("#"+a).appendTo("#"+r).hide()};e(document).on("click",".hw-gallery-meta-submit",function(a){a.preventDefault();var l=e(this),r=l.text(),t=l.data("hw-gallery-item"),o="hw-gallery-meta-"+t,i={};l.text(hw_gallery_metabox.saving),i.title=e("#hw-gallery-meta-table-"+t).find('textarea[name="_hw_gallery[meta_title]"]').val(),e("#hw-gallery-meta-table-"+t).find(":input").not(".ed_button").each(function(){e(this).data("hw-gallery-meta")&&(i[e(this).data("hw-gallery-meta")]=e(this).val())});var n={action:"hw_gallery_save_meta",nonce:hw_gallery_metabox.save_nonce,attach_id:t,post_id:hw_gallery_metabox.id,meta:i};e.post(hw_gallery_metabox.ajax,n,function(){setTimeout(function(){e("#"+o).appendTo("#"+t).hide(),l.text(r)},500)},"json")}),e("#hw-gallery-import-submit").on("click",function(a){e(this).next().css("display","inline-block"),0===e("#hw-gallery-config-import-gallery").val().length&&(a.preventDefault(),e(this).next().hide(),alert(hw_gallery_metabox.import))});var w=function(){var e=0;return function(a,l){clearTimeout(e),e=setTimeout(a,l)}}(),m=!1,f=function(a){a.preventDefault(),e("#hw-gallery-upload-ui").appendTo("#hw-gallery-upload-ui-wrapper").hide(),l(),m=!1};e(document).on("click","#hw-gallery-upload-ui .media-modal-close, #hw-gallery-upload-ui .media-modal-backdrop",f),e(document).on("keydown",function(e){27==e.keyCode&&m&&f(e)})})})(jQuery);